generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl= env("DIRECT_URL")
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum Role {
  CUSTOMER
  ORGANIZER
}

enum PaymentStatus {
  PENDING
  ACCEPTED
  REJECTED
}

//////////////////////////////////////////////////////
// USER
//////////////////////////////////////////////////////

model User {
  id           Int      @id @default(autoincrement())
  name         String
  email        String   @unique
  password     String
  role         Role
  referralCode String   @unique
  referredById Int?
  profileImage String?
  createdAt    DateTime @default(now())

  referredBy User?  @relation("Referral", fields: [referredById], references: [id])
  referrals  User[] @relation("Referral")

  points        Point[]
  events        Event[]  @relation("OrganizerEvents")
  payments      Payment[]
  coupons       Coupon[]

  @@map("users")
}

//////////////////////////////////////////////////////
// POINTS (WITH EXPIRATION)
//////////////////////////////////////////////////////

model Point {
  id         String   @id @default(uuid())
  userId     Int
  amount     Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  
  @@map("points")
}

//////////////////////////////////////////////////////
// COUPON (SYSTEM REWARD)
//////////////////////////////////////////////////////

model Voucher {
  id            Int       @id @default(autoincrement())
  eventId       Int
  code          String   @unique
  discount      Int
  expiresAt     DateTime
  createdAt     DateTime @default(now())

  event Event @relation(fields: [eventId], references: [id])
  payments Payment[]
  @@map("vouchers")
}

//////////////////////////////////////////////////////
// EVENT
//////////////////////////////////////////////////////

model Event {
  id             Int   @id @default(autoincrement())
  organizerId    Int
  title          String
  description    String
  price          Int
  totalSeats     Int
  date      DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organizer   User          @relation("OrganizerEvents", fields: [organizerId], references: [id])
  payment Payment[]
  coupons      Voucher[]

  @@map("events")
}

model Payment {
  id            String            @id @default(uuid())
  userId        Int
  eventId       Int
  quantity      Int
  totalPrice    Int
  status        PaymentStatus @default(PENDING)
  proof  String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  couponId    Int?
  voucherId   Int?

  user  User  @relation(fields: [userId], references: [id])
  event Event @relation(fields: [eventId], references: [id])
  coupon Coupon? @relation(fields: [couponId], references: [id])
  voucher Voucher? @relation(fields: [voucherId], references: [id])


  @@map("payments")
}

model Coupon {
  id             Int   @id @default(autoincrement())
  userId         Int
  code           String   @unique
  discountValue  Int
  isUsed         Boolean  @default(false)
  expiresAt      DateTime
  createdAt      DateTime @default(now())

  payments Payment[]

  user User @relation(fields: [userId], references: [id])

  @@map("coupons")
}



